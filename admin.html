<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .admin-card { background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 1rem; padding: 1.5rem; }
    .loading { border: 4px solid rgba(0,0,0,0.1); border-left-color: #1d4ed8; border-radius: 50%; width:24px; height:24px; animation: spin 1s linear infinite;}
    @keyframes spin { to { transform: rotate(360deg); } }
    .text-sm-condensed { font-size:0.8rem; line-height:1.2; }
    /* modal wide */
    .modal-large { width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
  </style>
</head>
<body class="p-8 md:p-12">
  <div class="max-w-6xl mx-auto space-y-8">
    <header class="text-center">
      <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
      <p class="text-gray-600">Manage census records for Our Lady of Fatima Shrine</p>
    </header>

    <!-- Search and Filter Section -->
    <div class="admin-card">
      <h2 class="text-xl font-bold mb-4">Search Records</h2>
      <div class="flex flex-col sm:flex-row gap-4">
        <input type="text" id="searchInput" placeholder="Search by First name, Last name, Block or Address" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300" />
        <button id="searchBtn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Search</button>
        <button id="viewAllBtn" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600">View All</button>
      </div>
    </div>

    <!-- Counts -->
    <div class="admin-card grid grid-cols-1 md:grid-cols-3 gap-6">
      <h2 class="text-xl font-bold col-span-full">Quick Counts</h2>
      <div class="bg-indigo-100 p-4 rounded-lg flex flex-col justify-center items-center">
        <p class="text-indigo-800 font-semibold">Total Households</p>
        <span id="householdCount" class="text-3xl font-bold text-indigo-900">...</span>
      </div>
      <div class="bg-indigo-100 p-4 rounded-lg flex flex-col justify-center items-center">
        <p class="text-indigo-800 font-semibold">Total Members</p>
        <span id="memberCount" class="text-3xl font-bold text-indigo-900">...</span>
      </div>
      <div class="bg-indigo-100 p-4 rounded-lg flex flex-col justify-center items-center">
        <p class="text-indigo-800 font-semibold">Total Children</p>
        <span id="childCount" class="text-3xl font-bold text-indigo-900">...</span>
      </div>
    </div>

    <!-- Results -->
    <div class="admin-card">
      <h2 class="text-xl font-bold mb-4">Census Records</h2>
      <div id="resultsContainer">
        <div id="loadingIndicator" class="hidden flex justify-center py-8"><div class="loading"></div></div>
        <div id="recordsList" class="space-y-6"></div>
        <div id="noResults" class="hidden text-center text-gray-500 py-8"><p>No records found. Try a different search.</p></div>
      </div>
    </div>

    <!-- Modal -->
    <div id="recordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl p-6 modal-large">
        <div class="flex justify-between items-center mb-4">
          <h3 id="modalTitle" class="text-xl font-bold">Record Details</h3>
          <div class="flex items-center gap-3">
            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
          </div>
        </div>
        <div id="modalContent"></div>

        <div class="mt-6 flex gap-3">
          <button id="printBtn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">
            <i class="fa-solid fa-print mr-2"></i> Print Record
          </button>
          <button id="editBtn" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600">
            <i class="fa-solid fa-pen-to-square mr-2"></i> Edit
          </button>
          <button id="deleteBtn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">
            <i class="fa-solid fa-trash-can mr-2"></i> Delete
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  // *** Update this to your deployed Google Apps Script Web App URL after you deploy the script below ***
  const API_URL = 'https://script.google.com/macros/s/AKfycbxgNJ3D1gIpEksX8lP5wLtvMto2JwCajxe9urjmA01HMFUe4vMXTFagCxVscTppoq3K/exec';

  let currentRecord = null; // currently opened household record

  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const viewAllBtn = document.getElementById('viewAllBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const recordsList = document.getElementById('recordsList');
    const noResults = document.getElementById('noResults');
    const recordModal = document.getElementById('recordModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalContent = document.getElementById('modalContent');
    const modalTitle = document.getElementById('modalTitle');
    const printBtn = document.getElementById('printBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const editBtn = document.getElementById('editBtn');

    const householdCountEl = document.getElementById('householdCount');
    const memberCountEl = document.getElementById('memberCount');
    const childCountEl = document.getElementById('childCount');

    // initial load
    fetchData();
    fetchCounts();

    searchBtn.addEventListener('click', () => {
      const q = searchInput.value.trim();
      fetchData(q);
    });

    viewAllBtn.addEventListener('click', () => {
      searchInput.value = '';
      fetchData();
    });

    closeModalBtn.addEventListener('click', () => {
      recordModal.classList.add('hidden');
      currentRecord = null;
    });

    printBtn.addEventListener('click', () => {
      const printContent = document.getElementById('modalContent').innerHTML;
      const newWin = window.open('', '_blank', 'width=800,height=600');
      newWin.document.write(`<html><head><title>Print</title></head><body>${printContent}</body></html>`);
      newWin.document.close();
      newWin.print();
    });

    deleteBtn.addEventListener('click', async () => {
      if (!currentRecord) return alert('No record selected.');
      if (!confirm('Are you sure you want to delete this household and all associated members/children? This cannot be undone.')) return;
      try {
        // POST delete
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'delete', householdId: currentRecord.household.HouseholdID })
        });
        const body = await resp.json();
        if (body.success) {
          alert('Record deleted.');
          recordModal.classList.add('hidden');
          currentRecord = null;
          fetchData(); // refresh
          fetchCounts();
        } else {
          alert('Delete failed: ' + (body.error || 'unknown error'));
        }
      } catch (err) {
        console.error(err);
        alert('Delete request failed. Check console and API deployment.');
      }
    });

    editBtn.addEventListener('click', () => {
      if (!currentRecord) return;
      openEditForm(currentRecord);
    });

    async function fetchCounts() {
      try {
        const r = await fetch(`${API_URL}?action=getCounts`);
        const j = await r.json();
        if (j.counts) {
          householdCountEl.textContent = j.counts.totalHouseholds ?? '0';
          memberCountEl.textContent = j.counts.totalMembers ?? '0';
          childCountEl.textContent = j.counts.totalChildren ?? '0';
        }
      } catch (err) {
        console.error('Counts error', err);
        householdCountEl.textContent = '...';
        memberCountEl.textContent = '...';
        childCountEl.textContent = '...';
      }
    }

    async function fetchData(q='') {
      loadingIndicator.classList.remove('hidden');
      recordsList.innerHTML = '';
      noResults.classList.add('hidden');

      try {
        const url = q ? `${API_URL}?action=search&q=${encodeURIComponent(q)}` : `${API_URL}?action=getAll`;
        const resp = await fetch(url);
        const data = await resp.json();
        if (Array.isArray(data) && data.length > 0) {
          renderRecords(data);
          noResults.classList.add('hidden');
        } else {
          noResults.classList.remove('hidden');
        }
      } catch (err) {
        console.error('Fetch error', err);
        noResults.classList.remove('hidden');
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    function renderRecords(records) {
      recordsList.innerHTML = '';
      records.forEach(record => {
        const h = record.household;
        const members = record.members || [];
        const children = record.children || [];

        const div = document.createElement('div');
        div.className = 'admin-card hover:bg-gray-50 transition duration-300 cursor-pointer';
        div.innerHTML = `
          <h3 class="text-lg font-bold text-blue-600">${escapeHtml(h.BlockName || '')} - ${escapeHtml(h.ResidentialAddress || '')}</h3>
          <p class="text-sm-condensed text-gray-500">Household ID: ${escapeHtml(h.HouseholdID || '')}</p>
          <p class="text-gray-700 mt-2 font-semibold">Members: <span class="font-normal">${members.length}</span></p>
          <p class="text-gray-700 font-semibold">Children: <span class="font-normal">${children.length}</span></p>
        `;
        div.addEventListener('click', () => showRecordDetails(record));
        recordsList.appendChild(div);
      });
    }

    function showRecordDetails(record) {
      currentRecord = record;
      const h = record.household || {};
      const members = record.members || [];
      const children = record.children || [];

      modalTitle.textContent = `Household: ${h.HouseholdID || ''} — ${h.BlockName || ''}`;

      let html = `<h4 class="text-lg font-bold text-gray-800 mb-2">Household Information</h4><ul class="list-disc list-inside space-y-1 mb-6">`;
      // Render all household keys/values
      for (const key in h) {
        html += `<li><strong>${escapeHtml(key)}:</strong> ${escapeHtml(h[key])}</li>`;
      }
      html += `</ul>`;

      if (members.length) {
        html += `<h4 class="text-lg font-bold text-gray-800 mb-2">Members</h4><div class="space-y-4 mb-6">`;
        members.forEach(m => {
          html += `<div class="p-4 bg-gray-100 rounded-lg"><p class="font-semibold">${escapeHtml(m.FirstName || '')} ${escapeHtml(m.LastName || '')}</p><ul class="list-disc list-inside text-sm-condensed space-y-1 mt-2">`;
          for (const k in m) {
            html += `<li><strong>${escapeHtml(k)}:</strong> ${escapeHtml(m[k])}</li>`;
          }
          html += `</ul></div>`;
        });
        html += `</div>`;
      }

      if (children.length) {
        html += `<h4 class="text-lg font-bold text-gray-800 mb-2">Children</h4><div class="space-y-4">`;
        children.forEach(c => {
          html += `<div class="p-4 bg-gray-100 rounded-lg"><p class="font-semibold">${escapeHtml(c.FirstName || '')} ${escapeHtml(c.LastName || '')}</p><ul class="list-disc list-inside text-sm-condensed space-y-1 mt-2">`;
          for (const k in c) {
            html += `<li><strong>${escapeHtml(k)}:</strong> ${escapeHtml(c[k])}</li>`;
          }
          html += `</ul></div>`;
        });
        html += `</div>`;
      }

      modalContent.innerHTML = html;
      recordModal.classList.remove('hidden');
    }

    // Build an edit form that mirrors index.html structure but prefilled.
    function openEditForm(record) {
      const h = record.household || {};
      const members = record.members || [];
      const children = record.children || [];

      modalTitle.textContent = `Edit Household: ${h.HouseholdID || ''}`;

      // form start
      let formHtml = `<form id="adminEditForm" class="space-y-6">`;

      // Household Info (basic)
      formHtml += `
        <div class="p-4 bg-blue-50 rounded-lg">
          <h4 class="font-bold mb-2">Household Information</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block font-medium">Block Name</label><input name="blockName" class="w-full border p-2 rounded" value="${escapeHtml(h.BlockName || '')}" /></div>
            <div><label class="block font-medium">Residential Address</label><input name="residentialAddress" class="w-full border p-2 rounded" value="${escapeHtml(h.ResidentialAddress || '')}" /></div>
            <div class="md:col-span-2"><label class="block font-medium">Contact Information</label><input name="contactInformation" class="w-full border p-2 rounded" value="${escapeHtml(h.ContactInformation || '')}" /></div>
          </div>
        </div>
      `;

      // Members — editable list
      formHtml += `<div class="p-4 bg-green-50 rounded-lg"><h4 class="font-bold mb-2">Members</h4><div id="adminMembers">`;
      members.forEach((m, idx) => {
        formHtml += `<div class="p-3 bg-white rounded mb-3 member-item" data-idx="${idx}">
          <div class="flex justify-between items-center mb-2"><strong>Member #${idx+1}</strong><button type="button" class="remove-member text-red-500">Remove</button></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div><label>First Name</label><input name="member-${idx}-firstName" class="w-full border p-2 rounded" value="${escapeHtml(m.FirstName || '')}" /></div>
            <div><label>Last Name</label><input name="member-${idx}-lastName" class="w-full border p-2 rounded" value="${escapeHtml(m.LastName || '')}" /></div>
            <div><label>Date of Birth</label><input name="member-${idx}-dateOfBirth" type="date" class="w-full border p-2 rounded" value="${escapeHtml(m.DateOfBirth || '')}" /></div>
            <div><label>Catholic?</label><input name="member-${idx}-catholic" class="w-full border p-2 rounded" value="${escapeHtml(m.Catholic || '')}" /></div>
            <!-- include other fields as hidden/simple inputs so they can be edited -->
            ${Object.keys(m).map(k => {
              if (['FirstName','LastName','DateOfBirth','Catholic'].includes(k)) return '';
              return `<input type="hidden" name="member-${idx}-${escapeHtml(k)}" value="${escapeHtml(m[k])}">`;
            }).join('')}
          </div>
        </div>`;
      });
      formHtml += `</div><div><button id="addMemberAdmin" type="button" class="mt-2 px-3 py-1 bg-green-600 text-white rounded">Add Member</button></div></div>`;

      // Children
      formHtml += `<div class="p-4 bg-red-50 rounded-lg"><h4 class="font-bold mb-2">Children</h4><div id="adminChildren">`;
      children.forEach((c, idx) => {
        formHtml += `<div class="p-3 bg-white rounded mb-3 child-item" data-idx="${idx}">
          <div class="flex justify-between items-center mb-2"><strong>Child #${idx+1}</strong><button type="button" class="remove-child text-red-500">Remove</button></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div><label>First Name</label><input name="child-${idx}-firstName" class="w-full border p-2 rounded" value="${escapeHtml(c.FirstName || '')}" /></div>
            <div><label>Last Name</label><input name="child-${idx}-lastName" class="w-full border p-2 rounded" value="${escapeHtml(c.LastName || '')}" /></div>
            <div><label>Date of Birth</label><input name="child-${idx}-dateOfBirth" type="date" class="w-full border p-2 rounded" value="${escapeHtml(c.DateOfBirth || '')}" /></div>
            <div><label>Age</label><input name="child-${idx}-age" type="number" class="w-full border p-2 rounded" value="${escapeHtml(c.Age || '')}" /></div>
            ${Object.keys(c).map(k => {
              if (['FirstName','LastName','DateOfBirth','Age'].includes(k)) return '';
              return `<input type="hidden" name="child-${idx}-${escapeHtml(k)}" value="${escapeHtml(c[k])}">`;
            }).join('')}
          </div>
        </div>`;
      });
      formHtml += `</div><div><button id="addChildAdmin" type="button" class="mt-2 px-3 py-1 bg-red-600 text-white rounded">Add Child</button></div></div>`;

      // Hidden household id
      formHtml += `<input type="hidden" name="HouseholdID" value="${escapeHtml(h.HouseholdID || '')}">`;

      // Submit + cancel
      formHtml += `<div class="flex gap-3"><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save Changes</button><button type="button" id="cancelEdit" class="px-4 py-2 bg-gray-300 rounded">Cancel</button></div>`;

      formHtml += `</form>`;

      modalContent.innerHTML = formHtml;

      // add handlers: add/remove member/child, cancel, submit
      document.getElementById('cancelEdit').addEventListener('click', () => {
        // show details again
        showRecordDetails(record);
      });

      // add member
      document.getElementById('addMemberAdmin').addEventListener('click', () => {
        const container = document.getElementById('adminMembers');
        const idx = container.querySelectorAll('.member-item').length;
        const node = document.createElement('div');
        node.className = 'p-3 bg-white rounded mb-3 member-item';
        node.dataset.idx = idx;
        node.innerHTML = `<div class="flex justify-between items-center mb-2"><strong>Member #${idx+1}</strong><button type="button" class="remove-member text-red-500">Remove</button></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div><label>First Name</label><input name="member-${idx}-firstName" class="w-full border p-2 rounded" /></div>
            <div><label>Last Name</label><input name="member-${idx}-lastName" class="w-full border p-2 rounded" /></div>
            <div><label>Date of Birth</label><input name="member-${idx}-dateOfBirth" type="date" class="w-full border p-2 rounded" /></div>
            <div><label>Catholic?</label><input name="member-${idx}-catholic" class="w-full border p-2 rounded" /></div>
          </div>`;
        container.appendChild(node);
        node.querySelector('.remove-member').addEventListener('click', () => node.remove());
      });

      // remove existing members
      document.querySelectorAll('.remove-member').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.member-item').remove();
        });
      });

      // add child
      document.getElementById('addChildAdmin').addEventListener('click', () => {
        const container = document.getElementById('adminChildren');
        const idx = container.querySelectorAll('.child-item').length;
        const node = document.createElement('div');
        node.className = 'p-3 bg-white rounded mb-3 child-item';
        node.dataset.idx = idx;
        node.innerHTML = `<div class="flex justify-between items-center mb-2"><strong>Child #${idx+1}</strong><button type="button" class="remove-child text-red-500">Remove</button></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div><label>First Name</label><input name="child-${idx}-firstName" class="w-full border p-2 rounded" /></div>
            <div><label>Last Name</label><input name="child-${idx}-lastName" class="w-full border p-2 rounded" /></div>
            <div><label>Date of Birth</label><input name="child-${idx}-dateOfBirth" type="date" class="w-full border p-2 rounded" /></div>
            <div><label>Age</label><input name="child-${idx}-age" type="number" class="w-full border p-2 rounded" /></div>
          </div>`;
        container.appendChild(node);
        node.querySelector('.remove-child').addEventListener('click', () => node.remove());
      });

      document.querySelectorAll('.remove-child').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.child-item').remove();
        });
      });

      // Submit handler: collect structured data then POST action=update
      document.getElementById('adminEditForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const form = ev.target;
        // build household object
        const fm = new FormData(form);
        const household = {
          HouseholdID: fm.get('HouseholdID'),
          BlockName: fm.get('blockName'),
          ResidentialAddress: fm.get('residentialAddress'),
          ContactInformation: fm.get('contactInformation')
        };

        // members: collect by scanning adminMembers children
        const members = [];
        document.querySelectorAll('#adminMembers .member-item').forEach((el, idx) => {
          const get = (name) => form.querySelector(`[name="${name}"]`) ? fm.get(name) : '';
          // for known keys:
          members.push({
            FirstName: fm.get(`member-${idx}-firstName`) || '',
            LastName: fm.get(`member-${idx}-lastName`) || '',
            DateOfBirth: fm.get(`member-${idx}-dateOfBirth`) || '',
            Catholic: fm.get(`member-${idx}-catholic`) || '',
            // Note: any hidden fields will be included if present in the DOM with names member-{idx}-KEY
            // Collect any additional inputs for this member:
            ...collectPrefixedFields(fm, `member-${idx}-`)
          });
        });

        // children:
        const children = [];
        document.querySelectorAll('#adminChildren .child-item').forEach((el, idx) => {
          children.push({
            FirstName: fm.get(`child-${idx}-firstName`) || '',
            LastName: fm.get(`child-${idx}-lastName`) || '',
            DateOfBirth: fm.get(`child-${idx}-dateOfBirth`) || '',
            Age: fm.get(`child-${idx}-age`) || '',
            ...collectPrefixedFields(fm, `child-${idx}-`)
          });
        });

        try {
          const resp = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'update', household, members, children })
          });
          const j = await resp.json();
          if (j.success) {
            alert('Household updated successfully.');
            recordModal.classList.add('hidden');
            // refresh list and counts
            fetchData();
            fetchCounts();
          } else {
            alert('Update failed: ' + (j.error || 'unknown error'));
          }
        } catch (err) {
          console.error(err);
          alert('Update request failed. Check console and API deployment.');
        }

      });

    } // end openEditForm

    // helpers
    function collectPrefixedFields(formData, prefix) {
      const out = {};
      for (const [k, v] of formData.entries()) {
        if (k.startsWith(prefix)) {
          const key = k.slice(prefix.length);
          if (!['firstName','lastName','dateOfBirth','age','catholic'].includes(key.toLowerCase())) {
            out[key] = v;
          }
        }
      }
      return out;
    }

    // HTML escaping helper to avoid injection when inserting free text
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

  }); // DOMContentLoaded
</script>
</body>
</html>
